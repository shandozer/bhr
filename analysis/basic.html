<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .bar {
        fill: steelblue;
    }

    .bar:hover {
        fill: brown;
    }

    .axis {
        font: 10px sans-serif;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    body {
        font: 10px sans-serif;
    }

    .arc path {
        stroke: #fff;
    }


</style>
<body>
<div id="charts">
    <div id="age-chart" class="chart">
        <div class="title">Age</div>
    </div>
    <div id="gender-chart" class="chart">
        <div class="title">Gender</div>
    </div>
</div>

<script src="bower_components/d3/d3.min.js"></script>
<script src="bower_components/crossfilter/crossfilter.min.js"></script>
<script>

    var margin = {top: 20, right: 20, bottom: 30, left: 40},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom,
            radius = Math.min(width, height) / 2;

    var color = d3.scale.ordinal()
            .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

    var arc = d3.svg.arc()
            .outerRadius(radius - 10)
            .innerRadius(0);

    var pie = d3.layout.pie()
            .sort(null)
            .value(function(d) {
                return d.value;
            });

    var gender_svg = d3.select("#gender-chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    var age_svg = d3.select("#age-chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    // Like d3.time.format, but faster.
    function parseDate(d) {
        return d3.time.format.utc("%Y-%m-%dT%H:%M:%S.%LZ").parse(d);
    }

    var insertLinebreaks = function (d) {
        var el = d3.select(this);
        var words = this.innerHTML.split("\n");
        el.text('');

        for (var i = 0; i < words.length; i++) {
            var tspan = el.append('tspan').text(words[i]);
            if (i > 0)
                tspan.attr('x', 0).attr('dy', '15');
        }
    };

    d3.csv("data.csv", function(error, subjects) {
        // Various formatters.
        var formatNumber = d3.format(",d"),
            formatPercent = d3.format("%"),
            formatChange = d3.format("+,d"),
            formatDate = d3.time.format("%B %d, %Y"),
            formatTime = d3.time.format("%I:%M %p");

        subjects.forEach(function(d, i) {
            d.index = i;
            d.date = parseDate(d.CreatedDate);
            d.age = +d.Age__c;
            d.gender = d.Gender__c;
        });

        var subject = crossfilter(subjects),
            all = subject.groupAll(),
            date = subject.dimension(function(d) { return d.date; }),
            dates = date.group(d3.time.day),
            hour = subject.dimension(function(d) { return d.date.getHours() + d.date.getMinutes() / 60; }),
            hours = hour.group(Math.floor),
            gender = subject.dimension(function(d) { return d.gender; }),
            genders = gender.group(),
            age = subject.dimension(function(d) { return Math.max(-60, Math.min(149, d.age)); }),
            ages = age.group(function(d) { return Math.floor(d / 10) * 10; });

        var g = gender_svg.selectAll(".arc")
                .data(pie(genders.all()))
                .enter().append("g")
                .attr("class", "arc");

        g.append("path")
                .attr("d", arc)
                .style("fill", function(d) { return color(d.value); });

        g.append("text")
                .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
                .attr("dy", ".35em")
                .style("text-anchor", "middle")
                .text(function(d) {
                    return (d.data.key || "Unknown") + "\n" + formatPercent(d.data.value/subject.size()) + " (" + d.data.value + ")";
                });

        g.selectAll('g text').each(insertLinebreaks);

        var a = age_svg.selectAll(".arc")
                .data(pie(ages.all()))
                .enter().append("g")
                .attr("class", "arc");

        a.append("path")
                .attr("d", arc)
                .style("fill", function(d) { return color(d.value); });

        a.append("text")
                .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
                .attr("dy", ".35em")
                .style("text-anchor", "middle")
                .text(function(d) {
                    return (d.data.key || "Unknown") + "\n" + formatPercent(d.data.value/subject.size()) + " (" + d.data.value + ")";
                });

        a.selectAll('g text').each(insertLinebreaks);


    });



</script>
</body>