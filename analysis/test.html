<!DOCTYPE html>
<html lang="en">
<head>
    <title>BHR Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap-theme.css" />
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="bower_components/dcjs/dc.css" />
</head>
<body>

<div class="container-fluid">
    <h1 class="page-header">BHR Dashboard <small id="report-date"></small></h1>

    <div class="row">
        <div id="test-chart" class="col-md-12">
            <strong>Test Completion</strong>
            <a class="reset" href="javascript:testChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
            <div class="clearfix"></div>
        </div>

    </div>

</div>

<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="bower_components/d3/d3.min.js"></script>
<script src="bower_components/crossfilter/crossfilter.min.js"></script>
<script src="bower_components/dcjs/dc.min.js"></script>
<script src="bower_components/momentjs/min/moment.min.js"></script>
<script>
    var reportDate = new Date().toLocaleDateString("en-US");
    $('#report-date').text(reportDate);
    
    var testChart = dc.barChart("#test-chart");
    d3.csv("completion.csv", function(error, completion) {
        // Various formatters.
        var formatNumber = d3.format(",d"),
                formatPercent = d3.format("%"),
                formatChange = d3.format("+,d"),
                formatDate = d3.time.format("%B %d, %Y"),
                formatTime = d3.time.format("%I:%M %p");

        completion.forEach(function(d, i) {
            d.index = i;
            d.date = moment(d.CreatedDate);
            d.tests = +d.Completed;
            d.rate = +d.CompletionRate;
        });

        var cf = crossfilter(completion);
        //var date = cf.dimension(function(d) { return d.date.getFullYear() * 100 + d.date.getMonth() + 1; });
                // dates = date.group(d3.time.week),
                // none = cf.dimension(function(d) { return d.tests; }).filterExact(0),
                // nones = none.group()
                // five = cf.dimension(function(d) { return d.tests; }).filterRange([1, 5]),
                // fives = five.group(),
                // ten = cf.dimension(function(d) { return d.tests; }).filterRange([6, 10]),
                // tens = ten.group();
                // all = cf.dimension(function(d) { return d.rate; }).filterExact(1),
                // alls = all.group();
                var date = cf.dimension(function(d) { return d.date.startOf('week'); });
                var tests = date.group().reduce(
                                function(p, v) {
                                    p.total++;
                                    if (v.tests == 0)
                                        p.nones++;
                                    if (v.tests > 0 && v.tests < 5)
                                        p.ones++;
                                    if (v.tests >= 5 && v.tests < 10)
                                        p.fives++;
                                    if (v.rate == 1)
                                        p.alls++;
                                    
                                    return p;
                                },
                                function(p, v) {
                                    p.total--;
                                    if (v.tests == 0)
                                        p.nones--;
                                    if (v.tests > 0 && v.tests < 5)
                                        p.ones--;
                                    if (v.tests > 5 && v.tests < 10)
                                        p.tens--;
                                    if (v.rate == 1)
                                        p.alls--;
                                    return p;
                                },
                                function() {
                                    return {
                                        total: 0,
                                        nones:0,
                                        ones:0,
                                        fives:0,
                                        tens:0,
                                        alls:0
                                    };
                                }
                            );

        
                testChart.height(180)
                        .margins({top: 40, right: 50, bottom: 30, left: 40})
                        .dimension(date)
                        .group(tests, "None")
                        .valueAccessor(function(d){
                            return d.value.nones/d.value.total;
                        })
                        .stack(tests, "1-5", function(d){return d.value.ones/d.value.total;})
                        .stack(tests, "5-10", function(d){return d.value.fives/d.value.total;})
                        .stack(tests, "10+", function(d){return d.value.tens/d.value.total;})
                        .stack(tests, "All", function(d){return d.value.alls/d.value.total;})
                        // .group(nones, "None")
                        // .stack(fives, "1-5")
                        // .stack(tens, "6-10")
                        // .stack(alls, "All")
                        .elasticY(true)
                        
                        .hidableStacks(true)
                    // (optional) whether bar should be center to its x value. Not needed for ordinal chart, :default=false
                        .centerBar(true)
                    // (optional) set gap between bars manually in px, :default=2
                        .gap(1)
                        .brushOn(true)
                        .legend(dc.legend().x(40).y(10).horizontal(true))
                    // (optional) set filter brush rounding
                        // .round(dc.round.floor)
                        // .title(function(d){ return d.value; })
                        // .label(function(d){ return d.key; })
                        //.alwaysUseRounding(true)
                        .x(d3.time.scale().domain([new Date(2013, 11, 1), new Date()]))
                        .xUnits(d3.time.weeks)
                        //.x(d3.scale.linear().domain([201311, 201404]))
                        // .round(d3.time.day.round)
                        // .xUnits(function(){return 10;})
                        .renderHorizontalGridLines(true)
                    // customize the filter displayed in the control span
                        .filterPrinter(function (filters) {
                            var filter = filters[0], s = "";
                            s += formatNumber(filter[0]) + " -> " + formatNumber(filter[1]);
                            return s;
                        });

                        testChart.yAxis().tickFormat(d3.format("%"));
            dc.renderAll();
    });
</script>
</body>
</html>